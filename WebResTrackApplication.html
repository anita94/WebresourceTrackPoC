<html>
  <head>
    <title></title>
    <meta content="">
    <style></style>
  </head>
  <body>
  <button type="button" id="Start Decoding" onclick="start()">Decode</button>

  <script>
/***********************************************Application****************************************************/  
    var fileName="track.xml"; // Track file contains initialization and media sample data.
    var trackURL;
    var sampleNum=1, browserSampleNum=0;
    var blobURLCache=new Array();
    //XMLHttpRequest is used to load the track file into the Application and the contents of track file
    //are saved as a Blob resource.
    var trackURL= getTrackAndCreateBlob(fileName);

    //When the 'Start Decoding' button is clicked, application gets here to and calls decoder.
    function start()
    {
        new decoder(trackURL);
    }
    //This callback happens as and when decoder gives an output- init or media segments.
    function decodeEventCallback(eventType,eventPayload)
    {
        if(eventType==0)//eventType is 0 for init segment and 1 for media segments.
        {
            var initBlobURL=createBlob(eventPayload);
            new browser(initBlobURL);// Call the browser to load initial webpage.
        }
        else
        {
            var blobURL=createBlob(eventPayload); //Create blobs for media samples.
            blobURLCache.push(blobURL);
        }
    }
/**********************************************************************************************************/

/******************************************Decoder*********************************************************/
class decoder{
    constructor(trackURL)
    {
            var self=this;
            //Create a XHR to obtain track data from the blob location.
            var request=blobRequest(trackURL);
            request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               //FileReader to be used to read received blob.
                var reader = new FileReader();
                reader.readAsText(request.response);
                reader.onload = function() {
                    //console.log('Reader output:', reader.result);
                    //The track data recieved is in xml and a xml parser is used.
                    var parser = new DOMParser();
                    var trackDataXml = parser.parseFromString(reader.result,"text/xml");
                    //Get the required element from the loaded xml.        
                    var initElem=trackDataXml.getElementsByTagName("init")[0];
                    var sampleCount=initElem.getElementsByTagName("sampleCount")[0].childNodes[0].nodeValue;
                    self.extractInit(initElem,sampleCount); // Function to extract init data and update to the Application.
                    
                    var template=initElem.getElementsByTagName("template")[0].childNodes[0].nodeValue;  
                    //Function to extract media sample data and update to the Application.
                    self.extractSample(trackDataXml,template,sampleCount);

                }   
             }
            };
    }
    //Function to extract init data from track file data.
    extractInit(initElem,sampleCount)
    {
        var initWeb=initElem.getElementsByTagName("initialWebpage")[0];
        var initData=initWeb.getElementsByTagName("html")[0].outerHTML;
        var payload= [sampleCount,initData];
        decodeEventCallback(0,payload);
    }
    //Function to extract media sample data.
     extractSample(trackDataXml,template,sampleCount)
    {   
        var self=this;
        if(sampleNum<=sampleCount)//Continue if the sample is present.
        {
            var sampleName=template.replace("$Number$",sampleNum);
            var sampleElement=trackDataXml.getElementsByTagName(sampleName);
            var decodeDur=sampleElement[0].getAttribute("decodeDur");
            var sampleType=sampleElement[0].getAttribute("sampleType");
            var sampleData=sampleElement[0].getElementsByTagName("script")[0].childNodes[0].nodeValue;
            var payload= [sampleName, sampleType, decodeDur, sampleData];
            sampleNum+=1;
            //Next segment extraction depending on the decode duration mentioned in the current sample.
            setTimeout(function(){self.extractSample(trackDataXml,template,sampleCount);},decodeDur*1000)
            decodeEventCallback(1,payload);
        
        }
    }
}
/******************************************Decoder*********************************************************/   

/******************************************Browser*********************************************************/ 
class browser{
    constructor(initBlobURL)
    {
        var winHandle,sampleCount,initResults;
        var self=this;
        var request =blobRequest(initBlobURL); // Request to load the blob resource.

        request.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var reader1 = new FileReader();
            reader1.readAsText(request.response);
            reader1.onload = function() {
                initResults=reader1.result.split(",");//Separate/split the payload into an array.
                sampleCount=initResults[0]; //Store the sample count
                winHandle = window.open(''); // Open new window to load initial webpage
                winHandle.document.open();
                winHandle.document.write(initResults[1]);
                }
            }
        };
            //Load media samples into the newly opened window.
        setTimeout(function(){self.loadSamples(winHandle,sampleCount);},1000);     
    }

    loadSamples(winHandle,sampleCount)
    {   var resultArray;
        var self=this;
        if(browserSampleNum<sampleCount)
        {
            var request =blobRequest(blobURLCache[browserSampleNum]);
            request.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var reader2 = new FileReader();
                    reader2.readAsText(request.response);
                    reader2.onload = function() {
                        resultArray=reader2.result.split(",");//Separate/split the payload into an array.
                        var script = document.createElement('script');
                        script.innerHTML = resultArray[3];
                        winHandle.document.body.appendChild(script);
                        browserSampleNum+=1;
                        setTimeout(function(){self.loadSamples(winHandle,sampleCount);},resultArray[2]*1000); //Next sample loading after decode duration. 
                    }
                }
            };
                
        }
    }
}

/******************************************Helper Functions************************************************/ 
function getTrackAndCreateBlob(fileName)
{
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var blobObj = new Blob([xhr.responseText], {type : "text/javascript"});
            trackURL = URL.createObjectURL(blobObj);
            return trackURL;
        }
    };
    xhr.open("GET", fileName, true);
    xhr.send();
}

function createBlob(Payload)
{
        var blobObj = new Blob([Payload], {type : "text/plain"});
        blobURL = URL.createObjectURL(blobObj);
        return blobURL;
}

function blobRequest(blobURL)
{
    var request = new XMLHttpRequest();
    request.open('GET', blobURL, true);
    request.responseType = 'blob';
    request.send();
    return request;
}

        
  </script>
  </body>
</html>